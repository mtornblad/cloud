{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "vmName": {
            "type": "string",
            "metadata": {
                "description": "Name of the Virtual Machine."
            }
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "Username for the Virtual Machine."
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for the Virtual Machine."
            }
        },
        "virtualNetworkName": {
            "type": "string",
            "metadata": {
                "description": "Name of existing network."
            }
        },
        "subnetName": {
            "type": "string",
            "metadata": {
                "description": "Name of existing network."
            },
            "defaultValue": "default"
        },
        "script": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Location of script to execute."
            }
        },
        "windowsOSVersion": {
            "type": "string",
            "defaultValue": "2019-Datacenter",
            "allowedValues": [
                "2008-R2-SP1",
                "2012-Datacenter",
                "2012-R2-Datacenter",
                "2016-Nano-Server",
                "2016-Datacenter-with-Containers",
                "2016-Datacenter",
                "2019-Datacenter"
            ],
            "metadata": {
                "description": "The Windows version for the VM. This will pick a fully patched image of this given Windows version."
            }
        },
        "domainName": {
            "type": "string",
            "metadata": {
                "description": "Name of Active Directory Domain"
            },
            "defaultValue": "contoso.com"
        },
        "roles": {
            "type": "array",
            "metadata": {
                "description": "Array with roles to deploy to this machine"
            },
            "defaultValue": [
            ]
        }
    },
    "variables": {
        "nicName": "[concat(parameters('vmName'), '-Nic')]",
        "publicIPAddressName": "[concat(parameters('vmName'), '-PublicIP')]",
        "subnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnetName'))]",
        "location": "[resourceGroup().location]"
    },
    "resources": [
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2018-11-01",
            "name": "[variables('publicIPAddressName')]",
            "location": "[variables('location')]",
            "properties": {
                "publicIPAllocationMethod": "Dynamic"
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2018-11-01",
            "name": "[variables('nicName')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"
                            },
                            "subnet": {
                                "id": "[variables('subnetRef')]"
                            }
                        }
                    }
                ],
                "dnsSettings": {
                    "dnsServers": [
                        "10.0.0.4",
                        "10.0.0.5",
                        "8.8.8.8"
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2018-10-01",
            "name": "[parameters('vmName')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces/', variables('nicName'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_DS2_v2"
                },
                "osProfile": {
                    "computerName": "[parameters('vmName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "[parameters('windowsOSVersion')]",
                        "version": "latest"
                    },
                    "osDisk": {
                        "createOption": "FromImage"
                    },
                    "dataDisks": [
                        {
                            "diskSizeGB": 1023,
                            "lun": 0,
                            "createOption": "Empty"
                        }
                    ]
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"
                        }
                    ]
                }
            }
        },
        {
            "apiVersion": "2018-06-01",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(parameters('vmName'), '/script')]",
            "location": "[variables('location')]",
            "condition": "[greater(length(parameters('script')), 0)]",

            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'))]"
            ],
            "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.7",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "fileUris": [
                        "[parameters('script')]"
                    ],
                    "commandToExecute": "[concat('powershell.exe -ExecutionPolicy Unrestricted -File dcpromo.ps1 -domainname \"olle.com\"')]"
                },
                "protectedSettings": {
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2019-03-01",
            "name": "[concat(parameters('vmName'), '/newforest')]",
            "location": "westeurope",
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'))]"
            ],
            "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.19",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "ModulesUrl": "https://shared.blob.core.windows.net/windows-powershell-dsc/NewForest.ps1.zip?st=2019-10-19T10%3A51%3A20Z&se=2021-10-20T10%3A51%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=jsJyxKh8e6i30sHPoPfTf%2Fl8IC%2FL%2FdOtpIzJPtczuSM%3D",
                    "ConfigurationFunction": "NewForest.ps1\\NewForest",
                    "Properties": {
                        "roles": "[parameters('roles')]",
                        "DomainName": "[parameters('domainName')]",
                        "AdminCreds": {
                            "UserName": "[parameters('adminUsername')]",
                            "Password": "PrivateSettingsRef:AdminPassword"
                        }
                    }
                },
                "protectedSettings": {
                    "Items": {
                        "AdminPassword": "[parameters('adminPassword')]"
                    }
                }
            }
        }
    ],
    "outputs": {
    }
}
 {
    "id": "/subscriptions/494df0b8-1c73-46ec-be20-86916386dba2/resourceGroups/Tenant1/providers/Microsoft.Resources/deployments/C1-SF01/operations/E69ABDB65F4DA806",
    "operationId": "E69ABDB65F4DA806",
    "properties": {
        "provisioningOperation": "Create",
        "provisioningState": "Failed",
        "timestamp": "2019-11-08T10:24:06.9121916Z",
        "duration": "PT2M57.0269876S",
        "trackingId": "33459a99-7fc5-4b80-8f89-59ff651bc230",
        "statusCode": "Conflict",
        "statusMessage": {
            "status": "Failed",
            "error": {
                "code": "ResourceDeploymentFailure",
                "message": "Resursåtgärden slutfördes med det slutliga etableringstillståndet Failed.",
                "details": [
                    {
                        "code": "VMExtensionProvisioningError",
                        "message": "Den virtuella datorn rapporterade ett fel vid bearbetningen av tillägget newforest. Felmeddelande: The DSC Extension received an incorrect input: Compilation errors occurred while processing configuration 'NewForest'. Please review the errors reported in error stream and modify your configuration code appropriately. Resource '[WindowsFeature]ADDS' required by '[WindowsFeature]RSAT' does not exist. Please ensure that the required resource exists and the name is properly formed. Cannot find path 'HKLM:\\SOFTWARE\\Microsoft\\PowerShell\\3\\DSC' because it does not exist. Cannot find path 'HKLM:\\SOFTWARE\\Microsoft\\PowerShell\\3\\DSC' because it does not exist. Cannot find path 'HKLM:\\SOFTWARE\\Microsoft\\PowerShell\\3\\DSC' because it does not exist. Cannot find path 'HKLM:\\SOFTWARE\\Microsoft\\PowerShell\\3\\DSC' because it does not exist. Resource '[WindowsFeature]ADDS' required by '[WindowsFeature]RSAT' does not exist. Please ensure that the required resource exists and the name is properly formed.\r\n\r\nAnother common error is to specify parameters of type PSCredential without an explicit type. Please be sure to use a typed parameter in DSC Configuration, for example:\r\n\r\n configuration Example {\r\n param([PSCredential] $UserAccount)\r\n ...\r\n }.\r\nPlease correct the input and retry executing the extension.."
                    }
                ]
            }
        },
        "targetResource": {
            "id": "/subscriptions/494df0b8-1c73-46ec-be20-86916386dba2/resourceGroups/Tenant1/providers/Microsoft.Compute/virtualMachines/C1-SF01/extensions/newforest",
            "resourceType": "Microsoft.Compute/virtualMachines/extensions",
            "resourceName": "C1-SF01/newforest"
        }
    }
}
